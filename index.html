<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>รายงานทรัพย์สิน คลังสินค้า Sparepart</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-bg: #f8f9fa;
      --white: #fff;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.15);
      --border-radius: 12px;
      --transition: all 0.3s ease;
    }
    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
      margin: 0;
      padding: 20px;
      color: #333;
      line-height: 1.6;
    }
    .report-title {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
      text-align: center;
      background: linear-gradient(135deg, var(--primary-color), #0056b3);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }
    .report-title::before {
      content: '\f1b2'; /* icon warehouse */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 32px;
      opacity: 0.8;
    }
    @media (max-width: 768px) {
      body { padding: 10px; }
      .report-title { font-size: 22px; padding: 15px; }
      .report-title::before { font-size: 24px; left: 15px; }
    }
    #searchContainer {
      background: var(--white);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      margin-bottom: 30px;
    }
    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }
    .search-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      justify-content: center;
    }
    #employeeFilterLabel, #pendingFilterLabel, #stockFilterLabel {
      font-size: 16px;
      color: #333;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #employeeFilter, #pendingFilter, #stockFilter {
      margin-left: 5px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 16px;
      background-color: var(--white);
      cursor: pointer;
      transition: var(--transition);
      min-width: 150px;
    }
    #employeeFilter:hover, #pendingFilter:hover, #stockFilter:hover {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }
    #searchInput {
      flex: 1;
      min-width: 250px;
      padding: 12px 16px;
      border-radius: var(--border-radius);
      border: 1px solid #ddd;
      font-size: 16px;
      transition: var(--transition);
    }
    #searchInput:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
      outline: none;
    }
    .action-button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--primary-color), #0056b3);
      color: var(--white);
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }
    .action-button:hover {
      background: linear-gradient(135deg, #0056b3, #004494);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .action-button:active {
      transform: translateY(0);
    }
    .action-button i { font-size: 16px; }
    .call-count-box {
      margin-left: auto;
      padding: 12px 16px;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: var(--primary-color);
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0,123,255,0.2);
    }
    .call-count-box span {
      color: var(--danger-color);
      margin: 0 4px;
      font-size: 20px;
      font-weight: 700;
    }
    .modern-label {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 10px 16px;
      background: var(--white);
      color: var(--primary-color);
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 500;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0,123,255,0.2);
      margin-right: 8px;
    }
    .table-container {
      overflow-x: auto;
      width: 100%;
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px; /* ลด min-width เพื่อกระชับ */
    }
    th, td {
      padding: 6px 8px; /* ลด padding */
      text-align: left;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
      font-size: 13px; /* ลด font-size */
    }
    th {
      background: linear-gradient(135deg, var(--primary-color), #0056b3);
      color: var(--white);
      font-weight: 600;
      position: sticky;
      top: 0;
      font-size: 12px; /* ลด font-size ใน header */
    }
    th.sortable { cursor: pointer; transition: var(--transition); }
    th.sortable:hover { background: linear-gradient(135deg, #0056b3, #004494); }
    .arrow { font-size: 10px; margin-left: 5px; }
    tr {
      transition: var(--transition);
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.6s ease forwards;
    }
    tr:hover {
      background-color: #f8f9fa;
      transform: scale(1.01);
    }
    tr:nth-child(even) { animation-delay: 0.1s; }
    tr:nth-child(odd) { animation-delay: 0.2s; }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }
    .transfer-button {
      padding: 6px 10px; /* ลด padding */
      background: linear-gradient(135deg, #6f42c1, #5a2d91);
      color: var(--white);
      border: none;
      width: 100%;
      border-radius: 6px; /* ลด border-radius */
      cursor: pointer;
      font-size: 12px; /* ลด font-size */
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }
    .transfer-button:hover {
      background: linear-gradient(135deg, #5a2d91, #4a1d6e);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .green-text { color: var(--success-color); font-weight: 500; }
    .red-text { color: var(--danger-color); font-weight: 500; }
    .orange-text { color: #fd7e14; font-weight: 500; }
    .yellow-light { background-color: #fff3cd; }
    .pink-pastel { background-color: #f8d7da; }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: var(--white);
      margin: 2% auto;
      padding: 24px;
      border-radius: var(--border-radius);
      width: 95%;
      max-width: 1000px;
      animation: zoomIn 0.4s ease;
      position: relative;
      box-shadow: var(--shadow-lg);
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      color: #333;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 8px;
      margin-bottom: 20px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      right: 20px;
      top: 15px;
      transition: var(--transition);
    }
    .close:hover { color: var(--danger-color); transform: scale(1.2); }
    .form-section {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--light-bg);
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary-color);
    }
    .form-section h3 {
      margin: 0 0 16px 0;
      color: var(--primary-color);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 600;
      color: #555;
      margin-bottom: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .form-input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition);
    }
    .form-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
      outline: none;
    }
    .form-input[readonly] {
      background-color: #f8f9fa;
      color: #666;
    }
    .search-row-modal {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }
    #tf_note {
      resize: vertical;
      min-height: 80px;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    #historyBox {
      display: none;
      margin-top: 24px;
      max-height: 400px; /* จำกัดความสูงเพื่อพอดีใน modal */
      overflow-y: auto;
    }
    #historyBox h3 {
      color: var(--primary-color);
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .timeline-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px; /* ลด font-size เพื่อกระชับ */
    }
    .timeline-table th, .timeline-table td {
      padding: 6px 8px; /* ลด padding */
      border: 1px solid #ddd;
      text-align: left;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .timeline-table th {
      background: linear-gradient(135deg, var(--primary-color), #0056b3);
      color: var(--white);
    }
    .delete-transfer-btn {
      background: linear-gradient(135deg, var(--danger-color), #c82333);
      color: var(--white);
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: var(--transition);
    }
    .delete-transfer-btn:hover {
      background: linear-gradient(135deg, #c82333, #bd2130);
      transform: translateY(-1px);
    }
    .picker-modal .modal-content { max-width: 600px; }
    #pickerList {
      max-height: 360px;
      overflow: auto;
      margin-top: 10px;
      border: 1px solid #eee;
      border-radius: 8px;
      background: var(--white);
    }
    .picker-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #f1f1f1;
      transition: var(--transition);
    }
    .picker-item:hover {
      background: #f8f9fa;
      color: var(--primary-color);
    }
    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .pagination button {
      padding: 8px 12px;
      background: var(--white);
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
    }
    .pagination button:hover:not(:disabled) {
      background: var(--primary-color);
      color: var(--white);
    }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-number.active {
      background: var(--primary-color);
      color: var(--white);
    }
    .items-per-page {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--secondary-color);
    }
    .loading i {
      font-size: 48px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes zoomIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    /* ปรับความกว้างคอลัมน์ให้พอดี */
    th:nth-child(1), td:nth-child(1) { width: 80px; min-width: 80px; } /* รหัส */
    th:nth-child(2), td:nth-child(2) { width: auto; min-width: 150px; max-width: 200px; white-space: normal; } /* ชื่อ */
    th:nth-child(3), td:nth-child(3) { width: 60px; min-width: 60px; } /* UL */
    th:nth-child(4), td:nth-child(4) { width: 120px; min-width: 120px; } /* Location */
    th:nth-child(5), td:nth-child(5) { width: 100px; min-width: 100px; } /* วันที่ซื้อ */
    th:nth-child(6), td:nth-child(6) { width: auto; min-width: 140px; } /* ผู้รับผิดชอบ */
    th:nth-child(7), td:nth-child(7) { width: 80px; min-width: 80px; } /* Status */
    th:nth-child(8), td:nth-child(8) { width: 80px; min-width: 80px; text-align: center; } /* อายุ */
    th:nth-child(9), td:nth-child(9) { width: 80px; min-width: 80px; } /* โอนย้าย */
    @media (max-width: 768px) {
      .filter-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      #searchInput { min-width: 100%; }
      .search-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      .action-button {
        width: 100%;
        justify-content: center;
        padding: 10px;
      }
      .table-container { border-radius: 8px; }
      th, td {
        padding: 4px 6px; /* ลด padding เพิ่มใน mobile */
        font-size: 11px;
        white-space: normal; /* อนุญาต wrap ใน mobile */
      }
      th:nth-child(2), td:nth-child(2) { min-width: 100px; max-width: 150px; }
      .form-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .modal-content {
        margin: 1% auto;
        padding: 16px;
        width: 98%;
        font-size: 14px;
      }
      .modal-buttons {
        justify-content: center;
        gap: 8px;
      }
      .pagination {
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .call-count-box {
        margin-left: 0;
        margin-top: 10px;
        width: 100%;
        justify-content: center;
        font-size: 14px;
      }
      .form-section { padding: 12px; }
      .search-row-modal { flex-direction: column; gap: 6px; }
      .action-button[style*="padding:8px 12px"] { width: 100%; }
      .timeline-table th, .timeline-table td { padding: 4px 6px; font-size: 11px; }
      .delete-transfer-btn { padding: 2px 6px; font-size: 10px; }
    }
    @media (max-width: 480px) {
      body { padding: 5px; }
      .report-title { font-size: 18px; padding: 12px; }
      table { font-size: 10px; }
      th, td { padding: 3px 4px; }
      .transfer-button { font-size: 10px; padding: 4px; }
    }
    .delete-button {
      background: linear-gradient(135deg, var(--danger-color), #c82333);
      color: var(--white);
    }
    .delete-button:hover {
      background: linear-gradient(135deg, #c82333, #bd2130);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <h1 class="report-title">รายงาน ทรัพย์สิน คลังสินค้าทั่วประเทศ</h1>
  <div id="searchContainer">
    <div class="filter-row">
      <label id="employeeFilterLabel" for="employeeFilter" class="modern-label"><i class="fas fa-user"></i> ผู้รับผิดชอบ</label>
      <select id="employeeFilter"><option value="">ทั้งหมด</option></select>
      <div id="ticketCountInfo" class="call-count-box"><i class="fas fa-tags"></i> จำนวนทรัพย์สิน: <span id="ticketCountValue">0</span> รายการ</div>
    </div>
    <div class="filter-row">
      <label id="pendingFilterLabel" for="pendingFilter" class="modern-label"><i class="fas fa-map-marker-alt"></i> Location</label>
      <select id="pendingFilter"><option value="">ทั้งหมด</option></select>
      <div id="callCountInfo" class="call-count-box"><i class="fas fa-list"></i> จำนวนรายการ: <span id="callCountValue">0</span> รายการ</div>
    </div>
    <div class="filter-row">
      <label id="stockFilterLabel" for="stockFilter" class="modern-label"><i class="fas fa-info-circle"></i> Status</label>
      <select id="stockFilter"><option value="">ทั้งหมด</option></select>
    </div>
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="ค้นหา รหัส, ชื่อ, UL, Location, วันที่ซื้อ, ผู้รับผิดชอบ, Status, อายุ..." />
      <button id="searchButton" class="action-button"><i class="fas fa-search"></i> ค้นหา</button>
      <button id="excelButton" class="action-button"><i class="fas fa-file-excel"></i> Excel</button>
    </div>
  </div>
  <div class="table-container">
    <table id="data-table">
      <thead>
        <tr>
          <th class="sortable" data-column="รหัสทรัพย์สิน"><i class="fas fa-tag"></i> รหัส <span class="arrow"></span></th>
          <th class="sortable" data-column="ชื่อทรัพย์สิน"><i class="fas fa-cube"></i> ชื่อ <span class="arrow"></span></th>
          <th class="sortable" data-column="UL"><i class="fas fa-building"></i> UL <span class="arrow"></span></th>
          <th class="sortable" data-column="Physical Location"><i class="fas fa-map-marker-alt"></i> Location <span class="arrow"></span></th>
          <th class="sortable" data-column="วันที่ซื้อทรัพย์สิน"><i class="fas fa-calendar"></i> วันที่ซื้อ <span class="arrow"></span></th>
          <th class="sortable" data-column="ผู้รับผิดชอบ"><i class="fas fa-user"></i> ผู้รับผิดชอบ <span class="arrow"></span></th>
          <th class="sortable" data-column="สถานะทรัพย์สิน"><i class="fas fa-info-circle"></i> Status <span class="arrow"></span></th>
          <th class="sortable" data-column="อายุ"><i class="fas fa-clock"></i> อายุ <span class="arrow"></span></th>
          <th><i class="fas fa-exchange-alt"></i> โอนย้าย</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="9" class="loading"><i class="fas fa-spinner"></i> กำลังโหลดข้อมูล...</td></tr>
      </tbody>
    </table>
  </div>
  <div class="pagination">
    <button id="firstPage"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i></button>
    <button id="prevPage"><i class="fas fa-chevron-left"></i></button>
    <div id="pageNumbers"></div>
    <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
    <button id="lastPage"><i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i></button>
    <div class="items-per-page">
      <label for="itemsPerPage"><i class="fas fa-list-ol"></i> รายการต่อหน้า:</label>
      <select id="itemsPerPage">
        <option value="10">10 รายการ</option>
        <option value="20" selected>20 รายการ</option>
        <option value="30">30 รายการ</option>
      </select>
    </div>
  </div>
  <!-- Transfer Modal -->
  <div id="transferModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeTransferModal">&times;</span>
      <h2><i class="fas fa-exchange-alt"></i> โอนย้ายทรัพย์สิน</h2>
      <form id="transferForm">
        <!-- กลุ่มข้อมูลทรัพย์สิน -->
        <div class="form-section">
          <h3><i class="fas fa-cube"></i> ข้อมูลทรัพย์สิน</h3>
          <div class="form-grid">
            <div class="form-group">
              <label><i class="fas fa-tag"></i> รหัส</label>
              <input type="text" id="tf_assetId" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label><i class="fas fa-cube"></i> ชื่อ</label>
              <input type="text" id="tf_name" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label><i class="fas fa-building"></i> UL</label>
              <input type="text" id="tf_ul" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label><i class="fas fa-map-marker-alt"></i> Location ปัจจุบัน</label>
              <input type="text" id="tf_fromLocation" class="form-input" readonly>
            </div>
          </div>
        </div>
        <!-- กลุ่มผู้โอน -->
        <div class="form-section">
          <h3><i class="fas fa-user-times"></i> ผู้โอน (ข้อมูลปัจจุบัน)</h3>
          <div class="form-grid">
            <div class="form-group">
              <label><i class="fas fa-id-card"></i> รหัสพนักงาน (ผู้โอน)</label>
              <input type="text" id="tf_fromEmpId" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label><i class="fas fa-user"></i> ผู้รับผิดชอบ (ผู้โอน)</label>
              <input type="text" id="tf_fromOwnerName" class="form-input" readonly placeholder="ชื่อผู้รับผิดชอบปัจจุบัน (ตัดรหัสพนักงานออก)">
            </div>
            <div class="form-group">
              <label><i class="fas fa-building"></i> UL (ผู้โอน)</label>
              <input type="text" id="tf_fromUL" class="form-input" readonly>
            </div>
          </div>
        </div>
        <!-- กลุ่มผู้รับและสถานที่ใหม่ -->
        <div class="form-section">
          <h3><i class="fas fa-user-plus"></i> ผู้รับและสถานที่ใหม่</h3>
          <div class="form-grid">
            <div class="form-group">
              <label><i class="fas fa-user-plus"></i> ผู้รับผิดชอบ (ผู้รับ)</label>
              <div class="search-row-modal">
                <input type="text" id="tf_toOwner" list="ownersList" placeholder="เลือก/ค้นหา ชื่อผู้รับผิดชอบใหม่" required class="form-input">
                <button type="button" id="btnFindOwner" class="action-button" style="padding:8px 12px; font-size:12px;"><i class="fas fa-search"></i></button>
              </div>
            </div>
            <div class="form-group">
              <label><i class="fas fa-id-card"></i> รหัสพนักงาน (ผู้รับ)</label>
              <input type="text" id="tf_toEmpId" class="form-input" placeholder="อัปเดตอัตโนมัติเมื่อเลือกชื่อ" readonly>
            </div>
            <div class="form-group">
              <label><i class="fas fa-building"></i> UL (ผู้รับ)</label>
              <input type="text" id="tf_toUL" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label><i class="fas fa-map-marker-alt"></i> ย้ายไป Location</label>
              <div class="search-row-modal">
                <input type="text" id="tf_toLocation" list="locationsList" placeholder="เลือก/ค้นหา Location ใหม่" required class="form-input">
                <button type="button" id="btnFindLocation" class="action-button" style="padding:8px 12px; font-size:12px;"><i class="fas fa-search"></i></button>
              </div>
            </div>
          </div>
        </div>
        <!-- กลุ่มข้อมูลเพิ่มเติม -->
        <div class="form-section">
          <h3><i class="fas fa-info-circle"></i> ข้อมูลเพิ่มเติม</h3>
          <div class="form-grid">
            <div class="form-group">
              <label><i class="fas fa-calendar"></i> วันที่โอน</label>
              <input type="date" id="tf_date" required class="form-input">
            </div>
            <div class="form-group">
              <label><i class="fas fa-user-edit"></i> ผู้ดำเนินการ</label>
              <input type="text" id="tf_operator" placeholder="ชื่อผู้ดำเนินการ (จำเป็น)" required class="form-input">
            </div>
          </div>
        </div>
        <div class="form-group">
          <label><i class="fas fa-sticky-note"></i> หมายเหตุ</label>
          <textarea id="tf_note" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)" class="form-input"></textarea>
        </div>
        <div class="modal-buttons">
          <button type="submit" class="action-button"><i class="fas fa-save"></i> บันทึกการโอนย้าย</button>
          <button type="button" id="viewHistoryBtn" class="action-button" style="background:linear-gradient(135deg,var(--secondary-color),#495057);"><i class="fas fa-history"></i> ดูประวัติ</button>
          <button type="button" id="printFormBtn" class="action-button" style="background:linear-gradient(135deg,var(--success-color),#20c997);"><i class="fas fa-print"></i> พิมพ์ฟอร์ม</button>
        </div>
        <datalist id="ownersList"></datalist>
        <datalist id="locationsList"></datalist>
      </form>
      <div id="historyBox">
        <h3><i class="fas fa-history"></i> ประวัติการโอนย้ายทรัพย์สิน</h3>
        <table class="timeline-table" id="historyTable">
          <thead>
            <tr>
              <th>วันที่โอน</th>
              <th>จาก Location</th>
              <th>ไป Location</th>
              <th>จากผู้รับผิดชอบ</th>
              <th>ผู้รับผิดชอบใหม่</th>
              <th>ผู้ดำเนินการ</th>
              <th>หมายเหตุ</th>
              <th style="width: 80px;">การจัดการ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="margin-top:16px;font-size:12px;color:var(--secondary-color);padding:12px;background:var(--light-bg);border-radius:8px;border-left:4px solid var(--primary-color);">
        <i class="fas fa-info-circle"></i> ระบบบันทึกข้อมูลใน localStorage ของเบราว์เซอร์ และส่งไป Supabase "transfers" อัตโนมัติ
      </div>
    </div>
  </div>
  <!-- Picker Modal -->
  <div id="pickerModal" class="modal picker-modal">
    <div class="modal-content">
      <span class="close" id="closePickerModal">&times;</span>
      <h2 id="pickerTitle">เลือกค่า</h2>
      <input type="text" id="pickerSearch" placeholder="พิมพ์เพื่อค้นหา..." class="form-input">
      <div id="pickerList"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase Config - ใช้ค่าจริงจากผู้ใช้
    const supabaseUrl = 'https://tdkjwnrchbzvffxxfefb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRka2p3bnJjaGJ6dmZmeHhmZWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMTg4NjUsImV4cCI6MjA3NzU5NDg2NX0.JGLfatFXW2mfZALLoxEbEP8OB5Kdl2uH3Ee_UhN3Kng';
    const { createClient } = supabase;
    const supabaseClient = createClient(supabaseUrl, supabaseKey);
    // DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
      const sheetID = '1caJemfomWLXEeqAlKFNMzGrT6divjSt5QZYeIjuTg58';
      const sheetName = 'ASSET';
      const url = `https://opensheet.elk.sh/${sheetID}/${sheetName}`;
      // DOM refs
      const transferModal = document.getElementById('transferModal');
      const closeTransferModal = document.getElementById('closeTransferModal');
      const transferForm = document.getElementById('transferForm');
      const historyBox = document.getElementById('historyBox');
      const historyTableBody = document.querySelector('#historyTable tbody');
      const viewHistoryBtn = document.getElementById('viewHistoryBtn');
      const ownersListEl = document.getElementById('ownersList');
      const locationsListEl = document.getElementById('locationsList');
      const pickerModal = document.getElementById('pickerModal');
      const closePickerModal = document.getElementById('closePickerModal');
      const pickerTitle = document.getElementById('pickerTitle');
      const pickerSearch = document.getElementById('pickerSearch');
      const pickerList = document.getElementById('pickerList');
      let pickerTarget = null;
      const btnFindOwner = document.getElementById('btnFindOwner');
      const btnFindLocation = document.getElementById('btnFindLocation');
      const employeeFilter = document.getElementById('employeeFilter');
      const pendingFilter = document.getElementById('pendingFilter');
      const stockFilter = document.getElementById('stockFilter');
      const searchInput = document.getElementById('searchInput');
      const searchButton = document.getElementById('searchButton');
      const excelButton = document.getElementById('excelButton');
      const tableBody = document.getElementById('tableBody');
      const pageNumbersContainer = document.getElementById('pageNumbers');
      const firstPageButton = document.getElementById('firstPage');
      const prevPageButton = document.getElementById('prevPage');
      const nextPageButton = document.getElementById('nextPage');
      const lastPageButton = document.getElementById('lastPage');
      const itemsPerPageSelect = document.getElementById('itemsPerPage');
      let allData = [];
      let currentPage = 1;
      let itemsPerPage = 20;
      let sortConfig = { column: 'รหัสทรัพย์สิน', direction: 'asc' };
      let currentAssetRow = null;
      function todayISO() {
        const d = new Date();
        const m = (d.getMonth() + 1).toString().padStart(2, '0');
        const day = d.getDate().toString().padStart(2, '0');
        return `${d.getFullYear()}-${m}-${day}`;
      }
      function calculateAge(purchaseDate) {
        if (!purchaseDate || purchaseDate === '-') return '-';
        try {
          const [day, month, year] = purchaseDate.split('/');
          const date = new Date(`${year}-${month}-${day}`);
          if (isNaN(date.getTime())) return '-';
          const today = new Date();
          let years = today.getFullYear() - date.getFullYear();
          let months = today.getMonth() - date.getMonth();
          if (months < 0 || (months === 0 && today.getDate() < date.getDate())) { years--; months += 12; }
          if (today.getDate() < date.getDate()) { months--; if (months < 0) { years--; months += 12; } }
          if (years < 0) return '-';
          return years === 0 && months === 0 ? '0 เดือน' : `${years} ปี ${months} เดือน`;
        } catch (e) { return '-'; }
      }
      function parseAgeForSorting(ageString) {
        if (ageString === '-') return { years: -Infinity, months: -Infinity };
        const match = ageString.match(/(\d+)\s*ปี\s*(\d+)\s*เดือน/);
        if (!match) {
          const monthMatch = ageString.match(/(\d+)\s*เดือน/);
          if (monthMatch) return { years: 0, months: parseInt(monthMatch[1]) };
          return { years: -Infinity, months: -Infinity };
        }
        return { years: parseInt(match[1]), months: parseInt(match[2]) };
      }
      function extractEmpId(text) {
        if (!text) return '';
        const m = String(text).trim().match(/^(\d{4,})\b/);
        return m ? m[1] : '';
      }
      function extractOwnerName(text) {
        if (!text) return '';
        return String(text).trim().replace(/^(\d{4,})\s*/, '').trim();
      }
      function findULByOwner(ownerName) {
        if (!ownerName) return '-';
        const match = allData.find(r => (r['ผู้รับผิดชอบ'] || '') === ownerName);
        return match ? (match['UL'] || '-') : '-';
      }
      function removeLeadingZeros(value) {
        if (!value || value === '-') return value;
        return String(value).replace(/^0+/, '') || '-';
      }
      function escapeCSVValue(value) {
        if (value == null) return '""';
        const s = value.toString();
        if (s.includes(',') || s.includes('"') || s.includes('\n')) return '"' + s.replace(/"/g, '""') + '"';
        return s;
      }
      function exportToCSV() {
        if (!allData || allData.length === 0) { alert('ไม่มีข้อมูลในระบบสำหรับการส่งออก CSV'); return; }
        const selectedEmployee = employeeFilter.value;
        const selectedLocation = pendingFilter.value;
        const selectedStatus = stockFilter.value;
        const keyword = searchInput.value.toLowerCase().trim();
        let filteredData = allData.filter(row => {
          if (!row) return false;
          const age = calculateAge(row['วันที่ซื้อทรัพย์สิน']);
          return (
            (!selectedEmployee || (row['ผู้รับผิดชอบ'] || '') === selectedEmployee) &&
            (!selectedLocation || (row['Physical Location'] || '') === selectedLocation) &&
            (!selectedStatus || (row['สถานะทรัพย์สิน'] || '') === selectedStatus) &&
            (!keyword ||
              removeLeadingZeros(row['รหัสทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              (row['ชื่อทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              (row['UL'] || '').toLowerCase().includes(keyword) ||
              (row['Physical Location'] || '').toLowerCase().includes(keyword) ||
              (row['วันที่ซื้อทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              (row['ผู้รับผิดชอบ'] || '').toLowerCase().includes(keyword) ||
              (row['สถานะทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              age.toLowerCase().includes(keyword)
            )
          );
        });
        if (filteredData.length === 0) { alert('ไม่มีข้อมูลที่ตรงกับเงื่อนไขการกรอง'); return; }
        filteredData.sort((a, b) => removeLeadingZeros(a['รหัสทรัพย์สิน'] || '').localeCompare(removeLeadingZeros(b['รหัสทรัพย์สิน'] || '')));
        const csvHeaders = ['รหัส', 'ชื่อ', 'UL', 'Location', 'วันที่ซื้อ', 'ผู้รับผิดชอบ', 'Status', 'อายุ'];
        const csvFields = ['รหัสทรัพย์สิน', 'ชื่อทรัพย์สิน', 'UL', 'Physical Location', 'วันที่ซื้อทรัพย์สิน', 'ผู้รับผิดชอบ', 'สถานะทรัพย์สิน'];
        const rows = [];
        rows.push(csvHeaders.map(c => `"${c}"`).join(','));
        filteredData.forEach(r => {
          const rowData = csvFields.map((field, index) => {
            let value = field === 'รหัสทรัพย์สิน' ? removeLeadingZeros(r[field]) : (field === 'อายุ' ? calculateAge(r['วันที่ซื้อทรัพย์สิน']) : (r[field] || '-'));
            return escapeCSVValue(value);
          });
          rows.push(rowData.join(','));
        });
        const csv = rows.join('\n');
        const bom = '\uFEFF';
        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `asset_report_${new Date().toISOString().replace(/[:.]/g, '-')}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
      }
      function populateEmployeeFilter(data) {
        if (!data || data.length === 0) return;
        const employees = [...new Set(data.map(r => r['ผู้รับผิดชอบ']).filter(Boolean))].sort();
        employeeFilter.innerHTML = '<option value="">ทั้งหมด</option>';
        employees.forEach(e => {
          const o = document.createElement('option');
          o.value = e;
          o.textContent = e;
          employeeFilter.appendChild(o);
        });
      }
      function updateLocationFilter(data, selectedEmployee) {
        if (!data || data.length === 0) return;
        const current = pendingFilter.value;
        const filtered = selectedEmployee ? data.filter(r => (r['ผู้รับผิดชอบ'] || '') === selectedEmployee) : data;
        const locations = [...new Set(filtered.map(r => r['Physical Location']).filter(Boolean))].sort();
        pendingFilter.innerHTML = '<option value="">ทั้งหมด</option>';
        locations.forEach(l => {
          const o = document.createElement('option');
          o.value = l;
          o.textContent = l;
          pendingFilter.appendChild(o);
        });
        pendingFilter.value = (current && locations.includes(current)) ? current : '';
        updateStatusFilter(data, selectedEmployee, pendingFilter.value);
      }
      function updateStatusFilter(data, selectedEmployee, selectedLocation) {
        if (!data || data.length === 0) return;
        const current = stockFilter.value;
        let filtered = data;
        if (selectedEmployee) filtered = filtered.filter(r => (r['ผู้รับผิดชอบ'] || '') === selectedEmployee);
        if (selectedLocation) filtered = filtered.filter(r => (r['Physical Location'] || '') === selectedLocation);
        const statuses = [...new Set(filtered.map(r => r['สถานะทรัพย์สิน']).filter(Boolean))].sort();
        stockFilter.innerHTML = '<option value="">ทั้งหมด</option>';
        statuses.forEach(s => {
          const o = document.createElement('option');
          o.value = s;
          o.textContent = s;
          stockFilter.appendChild(o);
        });
        stockFilter.value = (current && statuses.includes(current)) ? current : '';
      }
      function addSortListeners() {
        document.querySelectorAll('th.sortable').forEach(h => {
          h.addEventListener('click', () => {
            const col = h.getAttribute('data-column');
            if (sortConfig.column === col) {
              sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
              sortConfig.column = col;
              sortConfig.direction = 'asc';
            }
            updateSortArrows();
            filterAndRenderTable();
          });
        });
      }
      function updateSortArrows() {
        document.querySelectorAll('th.sortable').forEach(h => {
          const arrow = h.querySelector('.arrow');
          const col = h.getAttribute('data-column');
          arrow.textContent = (col === sortConfig.column) ? (sortConfig.direction === 'asc' ? '↑' : '↓') : '';
        });
      }
      function filterAndRenderTable() {
        const selectedEmployee = employeeFilter.value;
        const selectedLocation = pendingFilter.value;
        const selectedStatus = stockFilter.value;
        const keyword = searchInput.value.toLowerCase().trim();
        let filtered = allData.filter(row => {
          if (!row) return false;
          const age = calculateAge(row['วันที่ซื้อทรัพย์สิน']);
          return (
            (!selectedEmployee || (row['ผู้รับผิดชอบ'] || '') === selectedEmployee) &&
            (!selectedLocation || (row['Physical Location'] || '') === selectedLocation) &&
            (!selectedStatus || (row['สถานะทรัพย์สิน'] || '') === selectedStatus) &&
            (!keyword ||
              removeLeadingZeros(row['รหัสทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              (row['ชื่อทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              (row['UL'] || '').toLowerCase().includes(keyword) ||
              (row['Physical Location'] || '').toLowerCase().includes(keyword) ||
              (row['วันที่ซื้อทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              (row['ผู้รับผิดชอบ'] || '').toLowerCase().includes(keyword) ||
              (row['สถานะทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              age.toLowerCase().includes(keyword)
            )
          );
        });
        updateLocationFilter(allData, selectedEmployee);
        updateStatusFilter(allData, selectedEmployee, selectedLocation);
        const uniqueAssets = [...new Set(filtered.map(r => r['รหัสทรัพย์สิน']).filter(Boolean))].length;
        document.getElementById('ticketCountValue').textContent = uniqueAssets;
        if (sortConfig.column) {
          filtered.sort((a, b) => {
            if (sortConfig.column === 'อายุ') {
              const aAge = parseAgeForSorting(calculateAge(a['วันที่ซื้อทรัพย์สิน']));
              const bAge = parseAgeForSorting(calculateAge(b['วันที่ซื้อทรัพย์สิน']));
              if (aAge.years === bAge.years) return sortConfig.direction === 'asc' ? aAge.months - bAge.months : bAge.months - aAge.months;
              return sortConfig.direction === 'asc' ? aAge.years - bAge.years : bAge.years - aAge.years;
            }
            let va = (sortConfig.column === 'รหัสทรัพย์สิน' ? removeLeadingZeros(a[sortConfig.column] || '') : (a[sortConfig.column] || '')).toString().toLowerCase();
            let vb = (sortConfig.column === 'รหัสทรัพย์สิน' ? removeLeadingZeros(b[sortConfig.column] || '') : (b[sortConfig.column] || '')).toString().toLowerCase();
            if (va === vb) return 0;
            return sortConfig.direction === 'asc' ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
          });
        } else {
          filtered.sort((a, b) => removeLeadingZeros(a['รหัสทรัพย์สิน'] || '').localeCompare(removeLeadingZeros(b['รหัสทรัพย์สิน'] || '')));
        }
        renderTable(filtered);
        updateAssetCount(filtered);
      }
      function updateAssetCount(data) {
        const count = [...new Set(data.map(r => r['รหัสทรัพย์สิน']).filter(Boolean))].length;
        document.getElementById('callCountValue').textContent = count;
      }
      function renderTable(data) {
        tableBody.innerHTML = '';
        if (!data || data.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:40px; color:var(--secondary-color);">ไม่มีข้อมูลที่ตรงกับเงื่อนไข</td></tr>';
          return;
        }
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const page = data.slice(start, end);
        const assetGroups = {};
        data.forEach(r => {
          const a = r['รหัสทรัพย์สิน'];
          if (!assetGroups[a]) assetGroups[a] = [];
          assetGroups[a].push(r);
        });
        const uniq = Object.keys(assetGroups).sort();
        const colorMap = {};
        uniq.forEach((a, i) => { colorMap[a] = i % 2 === 0 ? 'yellow-light' : 'pink-pastel'; });
        page.forEach((row, i) => {
          const tr = document.createElement('tr');
          tr.style.animationDelay = `${i * 0.05}s`;
          const asset = row['รหัสทรัพย์สิน'];
          tr.className = colorMap[asset] || 'yellow-light';
          const columns = ['รหัสทรัพย์สิน', 'ชื่อทรัพย์สิน', 'UL', 'Physical Location', 'วันที่ซื้อทรัพย์สิน', 'ผู้รับผิดชอบ', 'สถานะทรัพย์สิน', 'อายุ'];
          columns.forEach(col => {
            const td = document.createElement('td');
            let cell = col === 'รหัสทรัพย์สิน' ? removeLeadingZeros(row[col]) : (col === 'อายุ' ? calculateAge(row['วันที่ซื้อทรัพย์สิน']) : (row[col] || '-'));
            let display = cell;
            if (col === 'สถานะทรัพย์สิน') {
              const n = cell.toString().trim().toLowerCase();
              if (n === 'stock' || n === 'ใช้งาน') {
                display = 'ใช้งาน';
                td.classList.add('green-text');
              } else if (n === 'โอนย้ายทรัพย์สิน') {
                display = 'โอนย้ายทรัพย์สิน';
                td.classList.add('orange-text');
              } else {
                display = 'ไม่ใช้งาน';
                td.classList.add('red-text');
              }
            } else if (col === 'อายุ') {
              td.classList.add('text-center');
            }
            td.textContent = display;
            tr.appendChild(td);
          });
          const transferTd = document.createElement('td');
          const btn = document.createElement('button');
          btn.innerHTML = '<i class="fas fa-exchange-alt"></i> โอนย้าย';
          btn.className = 'transfer-button';
          btn.onclick = () => openTransferModal(row);
          transferTd.appendChild(btn);
          tr.appendChild(transferTd);
          tableBody.appendChild(tr);
        });
        updatePagination(data.length);
      }
      function updatePagination(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        pageNumbersContainer.innerHTML = '';
        if (currentPage > totalPages) currentPage = totalPages || 1;
        const maxVisible = 5;
        const half = Math.floor(maxVisible / 2);
        let start = Math.max(1, currentPage - half);
        let end = Math.min(totalPages, start + maxVisible - 1);
        if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);
        for (let i = start; i <= end; i++) {
          const b = document.createElement('button');
          b.className = `page-number ${i === currentPage ? 'active' : ''}`;
          b.textContent = i;
          b.onclick = () => {
            currentPage = i;
            filterAndRenderTable();
          };
          pageNumbersContainer.appendChild(b);
        }
        firstPageButton.disabled = currentPage === 1;
        prevPageButton.disabled = currentPage === 1;
        nextPageButton.disabled = currentPage === totalPages;
        lastPageButton.disabled = currentPage === totalPages;
      }
      function getCurrentFilteredLength() {
        const selectedEmployee = employeeFilter.value;
        const selectedLocation = pendingFilter.value;
        const selectedStatus = stockFilter.value;
        const keyword = searchInput.value.toLowerCase().trim();
        return allData.filter(row => {
          if (!row) return false;
          const age = calculateAge(row['วันที่ซื้อทรัพย์สิน']);
          return (
            (!selectedEmployee || (row['ผู้รับผิดชอบ'] || '') === selectedEmployee) &&
            (!selectedLocation || (row['Physical Location'] || '') === selectedLocation) &&
            (!selectedStatus || (row['สถานะทรัพย์สิน'] || '') === selectedStatus) &&
            (!keyword ||
              removeLeadingZeros(row['รหัสทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              (row['ชื่อทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              (row['UL'] || '').toLowerCase().includes(keyword) ||
              (row['Physical Location'] || '').toLowerCase().includes(keyword) ||
              (row['วันที่ซื้อทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              (row['ผู้รับผิดชอบ'] || '').toLowerCase().includes(keyword) ||
              (row['สถานะทรัพย์สิน'] || '').toLowerCase().includes(keyword) ||
              age.toLowerCase().includes(keyword)
            )
          );
        }).length;
      }
      // Event listeners
      employeeFilter.addEventListener('change', filterAndRenderTable);
      pendingFilter.addEventListener('change', filterAndRenderTable);
      stockFilter.addEventListener('change', filterAndRenderTable);
      searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') filterAndRenderTable(); });
      searchButton.addEventListener('click', filterAndRenderTable);
      itemsPerPageSelect.addEventListener('change', (e) => {
        itemsPerPage = parseInt(e.target.value);
        currentPage = 1;
        filterAndRenderTable();
      });
      excelButton.addEventListener('click', exportToCSV);
      firstPageButton.onclick = () => { currentPage = 1; filterAndRenderTable(); };
      prevPageButton.onclick = () => { if (currentPage > 1) { currentPage--; filterAndRenderTable(); } };
      nextPageButton.onclick = () => {
        const total = Math.ceil(getCurrentFilteredLength() / itemsPerPage);
        if (currentPage < total) { currentPage++; filterAndRenderTable(); }
      };
      lastPageButton.onclick = () => {
        currentPage = Math.ceil(getCurrentFilteredLength() / itemsPerPage);
        filterAndRenderTable();
      };
      // Transfer Modal Functions
      function openTransferModal(row) {
        currentAssetRow = row;
        document.getElementById('tf_assetId').value = removeLeadingZeros(row['รหัสทรัพย์สิน'] || '-');
        document.getElementById('tf_name').value = row['ชื่อทรัพย์สิน'] || '-';
        document.getElementById('tf_ul').value = row['UL'] || '-';
        document.getElementById('tf_fromLocation').value = row['Physical Location'] || '-';
        const fromOwnerFull = row['ผู้รับผิดชอบ'] || '-';
        const fromEmpId = extractEmpId(fromOwnerFull);
        const fromOwnerName = extractOwnerName(fromOwnerFull);
        const fromUL = findULByOwner(fromOwnerFull);
        document.getElementById('tf_fromEmpId').value = fromEmpId;
        document.getElementById('tf_fromOwnerName').value = fromOwnerName;
        document.getElementById('tf_fromUL').value = fromUL;
        document.getElementById('tf_toLocation').value = '';
        document.getElementById('tf_toOwner').value = '';
        document.getElementById('tf_toEmpId').value = '';
        document.getElementById('tf_toUL').value = '';
        document.getElementById('tf_date').value = todayISO();
        document.getElementById('tf_operator').value = '';
        document.getElementById('tf_note').value = '';
        fillTransferDatalists();
        renderHistory(row['รหัสทรัพย์สิน']);
        historyBox.style.display = 'none';
        transferModal.style.display = 'block';
      }
      closeTransferModal.onclick = () => { transferModal.style.display = 'none'; currentAssetRow = null; };
      window.addEventListener('click', (e) => {
        if (e.target === transferModal) { transferModal.style.display = 'none'; currentAssetRow = null; }
        if (e.target === pickerModal) { pickerModal.style.display = 'none'; }
      });
      document.getElementById('tf_toOwner').addEventListener('input', () => {
        const toOwnerFull = document.getElementById('tf_toOwner').value;
        const toEmpId = extractEmpId(toOwnerFull);
        const toUL = findULByOwner(toOwnerFull);
        document.getElementById('tf_toEmpId').value = toEmpId;
        document.getElementById('tf_toUL').value = toUL;
      });
      viewHistoryBtn.addEventListener('click', () => {
        if (!currentAssetRow) return;
        renderHistory(currentAssetRow['รหัสทรัพย์สิน']);
        historyBox.style.display = (historyBox.style.display === 'none' || !historyBox.style.display) ? 'block' : 'none';
      });
      // ฟังก์ชันลบรายการประวัติเดี่ยว
      async function deleteSingleTransfer(transferId, assetId) {
        if (!confirm('คุณแน่ใจหรือไม่ที่จะลบรายการโอนย้ายนี้?')) return;
        try {
          // ลบจาก Supabase
          const { error: deleteError } = await supabaseClient
            .from('transfers')
            .delete()
            .eq('id', transferId);
          if (deleteError) throw deleteError;
          // ลบจาก localStorage
          let localList = JSON.parse(localStorage.getItem('assetTransfers') || '[]');
          localList = localList.filter(t => t.id !== transferId);
          localStorage.setItem('assetTransfers', JSON.stringify(localList));
          // Re-render history
          await renderHistory(assetId);
          alert('ลบรายการเรียบร้อย');
        } catch (err) {
          console.error('Delete error:', err);
          alert('เกิดข้อผิดพลาดในการลบ: ' + err.message);
        }
      }
      // เปลี่ยนฟังก์ชัน getTransfers/setTransfers เป็น Supabase + localStorage fallback
      async function getTransfers() {
        try {
          // ลองโหลดจาก Supabase ก่อน
          const { data: transfers, error } = await supabaseClient
            .from('transfers')
            .select('*')
            .order('created_at', { ascending: false });
          if (error) throw error;
          // Sync กับ localStorage ถ้า Supabase ว่างแต่ local มี
          const localTransfers = JSON.parse(localStorage.getItem('assetTransfers') || '[]');
          if (transfers && transfers.length === 0 && localTransfers.length > 0) {
            // Sync local to Supabase
            for (const t of localTransfers) {
              const { error: insertError, data: inserted } = await supabaseClient.from('transfers').insert([t]).select();
              if (insertError) console.error('Sync error:', insertError);
              else {
                // Update local with id if available
                const index = localTransfers.findIndex(lt => lt.asset_id === t.asset_id && lt.date === t.date);
                if (index !== -1 && inserted && inserted[0]) {
                  localTransfers[index].id = inserted[0].id;
                }
              }
            }
            localStorage.setItem('assetTransfers', JSON.stringify(localTransfers));
            localStorage.removeItem('assetTransfers'); // ลบ local หลัง sync
            return await getTransfers(); // Reload
          }
          return transfers || [];
        } catch (err) {
          console.error('Supabase error, fallback to localStorage:', err);
          return JSON.parse(localStorage.getItem('assetTransfers') || '[]');
        }
      }
      async function setTransfers(newPayload) {
        // บันทึก localStorage เสมอ (backup)
        const localList = JSON.parse(localStorage.getItem('assetTransfers') || '[]');
        localList.push(newPayload);
        localStorage.setItem('assetTransfers', JSON.stringify(localList));
        // ส่งไป Supabase
        try {
          const { error, data } = await supabaseClient
            .from('transfers')
            .insert([newPayload])
            .select();
          if (error) throw error;
          // ถ้าสำเร็จ, อัปเดต local ด้วย id
          if (data && data[0] && data[0].id) {
            const index = localList.findIndex(t => t.asset_id === newPayload.asset_id && t.date === newPayload.date);
            if (index !== -1) {
              localList[index].id = data[0].id;
              localStorage.setItem('assetTransfers', JSON.stringify(localList));
            }
          }
        } catch (err) {
          console.error('Supabase save error:', err);
          // Fallback: ใช้ localStorage เท่านั้น
        }
      }
      // renderHistory เปลี่ยนเป็น async
      async function renderHistory(assetId) {
        const transfers = (await getTransfers()).filter(t => t.asset_id === assetId);
        historyTableBody.innerHTML = '';
        if (transfers.length === 0) {
          historyTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:var(--secondary-color);">ยังไม่มีประวัติการโอนย้าย</td></tr>';
          return;
        }
        transfers.sort((a, b) => new Date(b.date) - new Date(a.date));
        transfers.forEach(t => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${t.date}</td>
            <td>${t.from_location || '-'}</td>
            <td>${t.to_location || '-'}</td>
            <td>${t.from_owner_name || '-'}</td>
            <td>${t.to_owner_name || '-'}</td>
            <td>${t.operator || '-'}</td>
            <td>${t.note || '-'}</td>
            <td style="text-align: center;" class="delete-col">${t.id ? '<button class="delete-transfer-btn"><i class="fas fa-trash"></i> ลบ</button>' : ''}</td>
          `;
          if (t.id) {
            const deleteBtn = tr.querySelector('.delete-col .delete-transfer-btn');
            deleteBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              e.stopPropagation();
              await deleteSingleTransfer(t.id, assetId);
            });
          }
          historyTableBody.appendChild(tr);
        });
      }
      // submitTransfer เปลี่ยนเป็น async (ใช้ setTransfers ใหม่)
      async function submitTransfer(e) {
        e.preventDefault();
        if (!currentAssetRow) { alert('ไม่พบข้อมูลทรัพย์สิน'); return; }
        // Validation (ข้อมูลกรอกไม่ครบถ้วน)
        const requiredFields = [
          { id: 'tf_toLocation', label: 'ย้ายไป Location' },
          { id: 'tf_toOwner', label: 'ผู้รับผิดชอบ (ผู้รับ)' },
          { id: 'tf_date', label: 'วันที่โอน' },
          { id: 'tf_operator', label: 'ผู้ดำเนินการ' }
        ];
        for (let field of requiredFields) {
          const el = document.getElementById(field.id);
          if (!el.value.trim()) {
            alert(`กรุณากรอกข้อมูลให้ครบถ้วน: ${field.label}`);
            el.focus();
            return;
          }
        }
        const fromOwnerFull = currentAssetRow['ผู้รับผิดชอบ'] || '-';
        const toOwnerFull = document.getElementById('tf_toOwner').value.trim();
        const payload = {
          asset_id: document.getElementById('tf_assetId').value,
          name: document.getElementById('tf_name').value,
          ul: document.getElementById('tf_ul').value,
          from_location: document.getElementById('tf_fromLocation').value,
          from_owner_full: fromOwnerFull,
          from_owner_name: extractOwnerName(fromOwnerFull),
          from_emp_id: document.getElementById('tf_fromEmpId').value,
          from_ul: document.getElementById('tf_fromUL').value,
          to_location: document.getElementById('tf_toLocation').value.trim(),
          to_owner_full: toOwnerFull,
          to_owner_name: extractOwnerName(toOwnerFull),
          to_emp_id: document.getElementById('tf_toEmpId').value.trim(),
          to_ul: document.getElementById('tf_toUL').value,
          date: document.getElementById('tf_date').value,
          operator: document.getElementById('tf_operator').value.trim(),
          note: document.getElementById('tf_note').value.trim(),
          status: 'โอนย้ายทรัพย์สิน'
        };
        // Save to Supabase + localStorage
        await setTransfers(payload);
        // Update allData
        const assetId = payload.asset_id;
        allData = allData.map(r => {
          if (r['รหัสทรัพย์สิน'] === assetId) {
            return { ...r, 'Physical Location': payload.to_location, 'ผู้รับผิดชอบ': payload.to_owner_full, 'สถานะทรัพย์สิน': 'โอนย้ายทรัพย์สิน', 'UL': payload.to_ul };
          }
          return r;
        });
        filterAndRenderTable();
        await renderHistory(assetId);
        historyBox.style.display = 'block';
        addValueToDatalists(payload.to_owner_full, payload.to_location);
        alert('บันทึกการโอนย้ายเรียบร้อย (บันทึกใน Supabase และ localStorage)');
        transferModal.style.display = 'none';
      }
      transferForm.addEventListener('submit', submitTransfer);
      // Datalist & Picker
      function uniqueSorted(arr) {
        return [...new Set(arr.filter(Boolean))].sort((a, b) => a.localeCompare(b, 'th'));
      }
      function fillTransferDatalists() {
        const owners = uniqueSorted(allData.map(r => r['ผู้รับผิดชอบ']));
        const locations = uniqueSorted(allData.map(r => r['Physical Location']));
        ownersListEl.innerHTML = owners.map(v => `<option value="${v}"></option>`).join('');
        locationsListEl.innerHTML = locations.map(v => `<option value="${v}"></option>`).join('');
      }
      function openPicker(type) {
        pickerTarget = type;
        const items = type === 'owner' ? [...ownersListEl.options].map(o => o.value) : [...locationsListEl.options].map(o => o.value);
        pickerTitle.textContent = type === 'owner' ? 'เลือกผู้รับผิดชอบใหม่' : 'เลือก Location ใหม่';
        renderPickerList(items);
        pickerSearch.value = '';
        pickerModal.style.display = 'block';
        setTimeout(() => pickerSearch.focus(), 0);
      }
      function renderPickerList(items) {
        if (!items || items.length === 0) {
          pickerList.innerHTML = '<div style="padding:20px;text-align:center;color:var(--secondary-color);">ไม่พบข้อมูล</div>';
          return;
        }
        pickerList.innerHTML = items.map(v => `<div class="picker-item" data-value="${v}">${v}</div>`).join('');
        pickerList.querySelectorAll('.picker-item').forEach(el => {
          el.addEventListener('click', () => {
            const val = el.getAttribute('data-value');
            if (pickerTarget === 'owner') {
              document.getElementById('tf_toOwner').value = val;
              document.getElementById('tf_toEmpId').value = extractEmpId(val);
              document.getElementById('tf_toUL').value = findULByOwner(val);
            } else {
              document.getElementById('tf_toLocation').value = val;
            }
            pickerModal.style.display = 'none';
          });
        });
      }
      pickerSearch.addEventListener('input', () => {
        const base = pickerTarget === 'owner' ? [...ownersListEl.options].map(o => o.value) : [...locationsListEl.options].map(o => o.value);
        const q = pickerSearch.value.toLowerCase();
        renderPickerList(base.filter(v => v.toLowerCase().includes(q)));
      });
      btnFindOwner.addEventListener('click', () => { fillTransferDatalists(); openPicker('owner'); });
      btnFindLocation.addEventListener('click', () => { fillTransferDatalists(); openPicker('location'); });
      closePickerModal.onclick = () => { pickerModal.style.display = 'none'; };
      function addValueToDatalists(owner, location) {
        if (owner) {
          const v = owner.trim();
          if (v && ![...ownersListEl.options].some(o => o.value === v)) {
            ownersListEl.insertAdjacentHTML('beforeend', `<option value="${v}"></option>`);
          }
        }
        if (location) {
          const v2 = location.trim();
          if (v2 && ![...locationsListEl.options].some(o => o.value === v2)) {
            locationsListEl.insertAdjacentHTML('beforeend', `<option value="${v2}"></option>`);
          }
        }
      }
      // Print Form
      document.getElementById('printFormBtn').addEventListener('click', () => {
        if (!currentAssetRow) { alert('กรุณาเลือกทรัพย์สินและกรอกฟอร์มก่อนพิมพ์'); return; }
        const fromOwnerFull = currentAssetRow['ผู้รับผิดชอบ'] || '-';
        const toOwnerFull = document.getElementById('tf_toOwner').value.trim();
        const payload = {
          assetId: document.getElementById('tf_assetId').value,
          name: document.getElementById('tf_name').value,
          ul: document.getElementById('tf_ul').value,
          fromLocation: document.getElementById('tf_fromLocation').value,
          fromOwnerName: extractOwnerName(fromOwnerFull),
          fromEmpId: document.getElementById('tf_fromEmpId').value,
          fromUL: document.getElementById('tf_fromUL').value,
          toLocation: document.getElementById('tf_toLocation').value,
          toOwnerName: extractOwnerName(toOwnerFull),
          toEmpId: document.getElementById('tf_toEmpId').value,
          toUL: document.getElementById('tf_toUL').value,
          date: document.getElementById('tf_date').value,
          operator: document.getElementById('tf_operator').value,
          note: document.getElementById('tf_note').value
        };
        printTransferForm(payload);
      });
      function thaiDateStr(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        const months = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
        return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
      }
      function printTransferForm(payload) {
        const w = window.open('', '_blank');
        const dateStr = thaiDateStr(payload.date) || '';
        const styles = `<style>
          @page { size: A4 landscape; margin: 12mm; }
          body { font-family: 'Prompt', Tahoma, sans-serif; color: #000; }
          h1 { font-size: 18pt; text-align: center; margin: 0 0 4mm; }
          h2 { font-size: 14pt; text-align: center; margin: 0 0 6mm; }
          .meta { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 11pt; }
          .meta .label { font-weight: bold; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #000; padding: 6px 4px; font-size: 11pt; }
          th { text-align: center; background: #fff; }
          .center { text-align: center; }
          .sign { margin-top: 12mm; display: grid; grid-template-columns: 1fr 1fr; gap: 12mm; font-size: 11pt; }
          .sign .box { border: 1px solid #000; padding: 6mm; min-height: 38mm; }
          .line { display: flex; gap: 6px; align-items: center; margin-top: 6px; }
          .line .lbl { min-width: 120px; }
          .line .fill { border-bottom: 1px solid #000; flex: 1; height: 16px; padding-bottom: 2px; }
          .line .info { flex: 1; text-align: center; font-weight: bold; border-bottom: none; padding-top: 2px; }
        </style>`;
        const header = `<h1>บริษัท ซีพี รีเทลลิงค์ จำกัด</h1><h2>ใบโอนย้ายทรัพย์สิน</h2><div class="meta"><div><span class="label">รายละเอียดครั้งนี้ :</span> ${payload.note || ''}</div><div><span class="label">วันที่ :</span> ${dateStr}</div></div>`;
        const firstRow = `<tr><td class="center">1</td><td class="center">${payload.assetId || ''}</td><td>${payload.name || ''}</td><td class="center">${payload.ul || ''}</td><td class="center">${payload.fromEmpId || ''}</td><td>${payload.fromOwnerName || ''}</td><td class="center">${payload.ul || ''}</td><td class="center">${payload.toEmpId || ''}</td><td>${payload.toOwnerName || ''}</td><td>${payload.note || ''}</td></tr>`;
        const emptyRows = Array.from({ length: 7 }, (_, i) => `<tr><td class="center">${i + 2}</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`).join('');
        const table = `<table><thead><tr><th rowspan="2" style="width:40px">ลำดับ</th><th rowspan="2" style="width:120px">รหัสทรัพย์สิน</th><th rowspan="2">รายการ</th><th colspan="3">ผู้โอน</th><th colspan="3">ผู้รับ</th><th rowspan="2" style="width:160px">หมายเหตุ</th></tr><tr><th style="width:90px">UL</th><th style="width:120px">รหัสพนักงาน</th><th style="width:160px">ชื่อผู้รับผิดชอบเดิม</th><th style="width:90px">UL</th><th style="width:120px">รหัสพนักงาน</th><th style="width:160px">ชื่อผู้รับผิดชอบใหม่</th></tr></thead><tbody>${firstRow}${emptyRows}</tbody></table>`;
        const signFrom = `<div class="box"><div class="center" style="font-weight:bold;margin-bottom:6px;">ผู้โอน</div><div class="line"><div class="lbl">ลายเซ็นต์</div><div class="fill"></div></div><div class="line"><div class="lbl">ชื่อตัวบรรจง</div><div class="info">${payload.fromOwnerName || ''}</div></div><div class="line"><div class="lbl">รหัสพนักงาน</div><div class="info">${payload.fromEmpId || ''}</div></div><div class="line"><div class="lbl">หน่วยงาน</div><div class="fill"></div></div></div>`;
        const signTo = `<div class="box"><div class="center" style="font-weight:bold;margin-bottom:6px;">ผู้รับ</div><div class="line"><div class="lbl">ลายเซ็นต์</div><div class="fill"></div></div><div class="line"><div class="lbl">ชื่อตัวบรรจง</div><div class="info">${payload.toOwnerName || ''}</div></div><div class="line"><div class="lbl">รหัสพนักงาน</div><div class="info">${payload.toEmpId || ''}</div></div><div class="line"><div class="lbl">หน่วยงาน</div><div class="fill"></div></div></div>`;
        const sign = `<div class="sign">${signFrom}${signTo}</div>`;
        w.document.write(`<html><head><title>พิมพ์ใบโอนย้ายทรัพย์สิน</title>${styles}</head><body>${header}${table}${sign}</body></html>`);
        w.document.close();
        w.focus();
        w.print();
      }
      // Load Data
      fetch(url)
        .then(r => {
          if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
          return r.json();
        })
        .then(data => {
          if (!data || data.length === 0) {
            console.error('No data received from Google Sheets');
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:40px; color:var(--secondary-color);">ไม่มีข้อมูลจาก Google Sheets</td></tr>';
            return;
          }
          // Process data to remove leading zeros in asset_id for display
          allData = data.map(row => ({
            ...row,
            'รหัสทรัพย์สิน': removeLeadingZeros(row['รหัสทรัพย์สิน'])
          }));
          populateEmployeeFilter(allData);
          updateLocationFilter(allData, '');
          updateStatusFilter(allData, '', '');
          addSortListeners();
          updateSortArrows();
          filterAndRenderTable();
          runSelfTests();
          // Preload transfers (optional)
          getTransfers().catch(console.error);
        })
        .catch(err => {
          console.error('ไม่สามารถโหลดข้อมูลได้:', err);
          tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:40px; color:var(--danger-color);">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${err.message}</td></tr>`;
        });
      // Self-tests
      function runSelfTests() {
        try {
          console.assert(!!document.getElementById('data-table'), 'ตารางหลักไม่พบ');
          console.assert(typeof extractEmpId === 'function', 'extractEmpId หายไป');
          console.assert(extractEmpId('7512578 ณัลริษาณ์ ชุติสมบูรณ์ไชย') === '7512578', 'extractEmpId ไม่ดึงตัวเลขต้นสตริง');
          console.assert(extractOwnerName('7512578 ณัลริษาณ์ ชุติสมบูรณ์ไชย') === 'ณัลริษาณ์ ชุติสมบูรณ์ไชย', 'extractOwnerName ไม่ตัดรหัส');
          console.assert(parseAgeForSorting('1 ปี 2 เดือน').years === 1, 'parseAgeForSorting.year');
          console.assert(removeLeadingZeros('000000000505') === '505', 'removeLeadingZeros ไม่ทำงาน');
          filterAndRenderTable();
        } catch (e) {
          console.warn('Self-test พบปัญหา (ไม่ร้ายแรง):', e);
        }
      }
    });
  </script>
</body>
</html>
